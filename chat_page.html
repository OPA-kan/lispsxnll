{% extends "base.html" %}
{% block title %}DM with {{ other_user.username }}{% endblock %}

{% block head %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 80px); /* Adjust height for header/footer */
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: var(--background-white);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
    }
    .chat-header {
        display: flex;
        align-items: center;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 20px;
    }
    .chat-header h2 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        margin-left: 15px;
    }
    .messages-list {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0 10px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 20px;
        word-wrap: break-word;
        position: relative;
    }
    .message-bubble.sent {
        background-color: var(--primary-color);
        color: white;
        align-self: flex-end;
    }
    .message-bubble.received {
        background-color: var(--background-light);
        color: var(--text-dark);
        align-self: flex-start;
    }
    .message-meta {
        font-size: 0.75rem;
        color: var(--text-light);
        margin-top: 5px;
        text-align: right;
    }
    .message-meta.sent {
        text-align: right;
    }
    .message-meta.received {
        text-align: left;
    }
    .message-sender {
        font-weight: 600;
        margin-right: 8px;
    }
    .input-area {
        display: flex;
        align-items: center;
        margin-top: 20px;
        gap: 10px;
    }
    .input-area textarea {
        flex-grow: 1;
        border-radius: 25px;
        padding: 12px 20px;
        resize: none;
        height: 50px;
        border: 1px solid var(--border-color);
        transition: border-color 0.2s ease;
    }
    .input-area textarea:focus {
        border-color: var(--primary-color);
        outline: none;
    }
    .input-area button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .input-area button:hover {
        background-color: #2436d8;
        transform: scale(1.05);
    }
    /* ロード中のアニメーション */
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: var(--text-light);
    }
    .loading-spinner i {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<main class="main-content">
    <div class="chat-container">
        <div class="chat-header">
            <a href="/dm" class="text-gray-500 hover:text-gray-900 transition-colors">
                <i class="fas fa-arrow-left fa-lg"></i>
            </a>
            <img src="{{ other_user.profile_picture_url }}" alt="{{ other_user.username }}'s profile" class="profile-image-small ml-4">
            <h2>{{ other_user.username }}</h2>
        </div>
        <div class="messages-list" id="messages-list">
            <!-- Messages will be loaded here -->
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
            </div>
        </div>
        <div class="input-area">
            <textarea id="message-input" placeholder="メッセージを入力..."></textarea>
            <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const messageList = document.getElementById('messages-list');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const otherUserId = {{ other_user.id }};
    let myUserId = '{{ current_user.id }}';

    // メッセージをHTMLに追加する関数
    const addMessageToDOM = (message) => {
        const messageBubble = document.createElement('div');
        messageBubble.classList.add('message-bubble');
        if (message.sender_id.toString() === myUserId) {
            messageBubble.classList.add('sent');
        } else {
            messageBubble.classList.add('received');
        }

        const messageContent = document.createElement('p');
        messageContent.textContent = message.content;
        messageBubble.appendChild(messageContent);
        
        const messageMeta = document.createElement('div');
        messageMeta.classList.add('message-meta');
        messageMeta.textContent = message.timestamp;
        messageBubble.appendChild(messageMeta);
        
        messageList.appendChild(messageBubble);
        messageList.scrollTop = messageList.scrollHeight; // スクロールを一番下へ
    };

    // チャット履歴をロード
    const loadChatHistory = async () => {
        try {
            const response = await fetch(`/dm/api/dms/${otherUserId}/messages`);
            const data = await response.json();
            
            messageList.innerHTML = ''; // ローディングスピナーをクリア
            data.messages.forEach(addMessageToDOM);
            
            // SocketIOルームに参加
            socket.emit('join_dm_room', { conversation_id: data.conversation_id });
        } catch (error) {
            console.error('チャット履歴のロードに失敗しました:', error);
            messageList.innerHTML = '<p class="text-center text-red-500">チャット履歴のロードに失敗しました。</p>';
        }
    };
    
    // メッセージ送信
    const sendMessage = () => {
        const content = messageInput.value.trim();
        if (content) {
            socket.emit('send_dm', {
                recipient_id: otherUserId,
                content: content
            });
            messageInput.value = '';
        }
    };

    // エンターキーで送信
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    sendBtn.addEventListener('click', sendMessage);

    // SocketIOイベントリスナー
    socket.on('receive_dm', (data) => {
        // 自分のIDまたは相手のIDからのメッセージか確認
        if (data.sender_id.toString() === myUserId || data.sender_id.toString() === otherUserId.toString()) {
            addMessageToDOM(data);
        }
    });

    // ページ読み込み時にチャット履歴をロード
    window.onload = loadChatHistory;
    
</script>
{% endblock %}
